generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  USER
  COACH
  ADMIN
}

enum SubscriptionTier {
  FREE
  PRO
  ELITE
}

enum AnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum PlanStatus {
  ACTIVE
  PAUSED
  COMPLETED
  ABANDONED
}

enum MediaType {
  VIDEO
  IMAGE
}

enum TokenType {
  PASSWORD_RESET
  EMAIL_VERIFICATION
}

enum BadgeType {
  FIRST_ANALYSIS
  WEEK_PERFECT
  PLAN_COMPLETED
  IMPROVEMENT
  DEDICATION_30
  STREAK_7
  STREAK_30
  STREAK_100
}

enum DocumentStatus {
  UPLOADING
  PROCESSING
  COMPLETED
  FAILED
}

enum ChunkCategory {
  THEORY
  EXERCISE
  TRAINING_PLAN
  GENERAL
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id            String           @id @default(cuid())
  email         String           @unique
  name          String?
  password      String
  image         String?
  role          UserRole         @default(USER)
  subscription  SubscriptionTier @default(FREE)

  // Email verification
  emailVerified DateTime?

  // Onboarding
  onboardingCompleted Boolean @default(false)

  // Stripe fields
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?
  stripeCurrentPeriodEnd DateTime?

  // Email notification preferences
  emailNotifications Boolean @default(true)
  reminderTime       String? // HH:mm format for daily reminders

  favoriteSports  UserSport[]
  preferredAngles String[]       @default([])

  analyses        Analysis[]
  trainingPlans   TrainingPlan[]
  progressLogs    ProgressLog[]

  // Gamification
  streak          UserStreak?
  badges          UserBadge[]
  activityLogs    ActivityLog[]

  // Auth tokens
  verificationTokens VerificationToken[]

  // RAG documents
  documents       Document[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  lastLoginAt     DateTime?

  @@map("users")
}

model UserSport {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sportId   String
  sport     Sport    @relation(fields: [sportId], references: [id])
  level     String?
  yearsExp  Int?
  createdAt DateTime @default(now())

  @@unique([userId, sportId])
  @@map("user_sports")
}

// ============================================
// SPORTS CATALOG
// ============================================

model Sport {
  id          String      @id @default(cuid())
  slug        String      @unique
  name        String      @unique
  description String?
  icon        String?
  isActive    Boolean     @default(true)
  order       Int         @default(0)

  techniques  Technique[]
  users       UserSport[]

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("sports")
}

model Technique {
  id           String    @id @default(cuid())
  sportId      String
  sport        Sport     @relation(fields: [sportId], references: [id], onDelete: Cascade)
  slug         String
  name         String
  description  String?
  difficulty   Int       @default(1)

  correctForm  Json?
  commonErrors Json?
  keyPoints    String[]

  variants     Variant[]
  analyses     Analysis[]

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([sportId, slug])
  @@map("techniques")
}

model Variant {
  id             String    @id @default(cuid())
  techniqueId    String
  technique      Technique @relation(fields: [techniqueId], references: [id], onDelete: Cascade)
  slug           String
  name           String
  description    String?

  correctForm    Json?
  keyDifferences String[]

  analyses       Analysis[]

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([techniqueId, slug])
  @@map("variants")
}

// ============================================
// ANALYSIS
// ============================================

model Analysis {
  id            String         @id @default(cuid())
  userId        String
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  techniqueId   String
  technique     Technique      @relation(fields: [techniqueId], references: [id])
  variantId     String?
  variant       Variant?       @relation(fields: [variantId], references: [id])

  mediaItems    MediaItem[]

  status              AnalysisStatus @default(PENDING)
  errorMessage        String?
  processingMs        Int?
  processingStartedAt DateTime?
  retryCount          Int            @default(0)

  overallScore  Float?
  aiResponse    Json?
  summary       String?
  strengths     String[]       @default([])
  priorityFocus String?

  issues        Issue[]

  trainingPlan  TrainingPlan?

  previousAnalysisId String?   @unique
  previousAnalysis   Analysis? @relation("ProgressComparison", fields: [previousAnalysisId], references: [id])
  nextAnalysis       Analysis? @relation("ProgressComparison")

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([userId, createdAt])
  @@index([techniqueId])
  @@map("analyses")
}

model MediaItem {
  id           String    @id @default(cuid())
  analysisId   String
  analysis     Analysis  @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  type         MediaType
  url          String
  thumbnailUrl String?
  filename     String
  fileSize     Int
  duration     Int?
  angle        String?

  frameUrls    String[]  @default([])

  createdAt    DateTime  @default(now())

  @@map("media_items")
}

model Issue {
  id          String     @id @default(cuid())
  analysisId  String
  analysis    Analysis   @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  category    String
  title       String
  description String
  severity    Severity

  correction  String
  drills      String[]

  timestamp   Float?
  frameUrl    String?

  exercises   ExerciseIssue[]

  createdAt   DateTime   @default(now())

  @@index([analysisId])
  @@map("issues")
}

// ============================================
// TRAINING PLANS
// ============================================

model TrainingPlan {
  id            String       @id @default(cuid())
  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  analysisId    String       @unique
  analysis      Analysis     @relation(fields: [analysisId], references: [id])

  title         String
  description   String?
  durationDays  Int
  difficulty    Int          @default(1)

  status        PlanStatus   @default(ACTIVE)

  exercises     Exercise[]
  progressLogs  ProgressLog[]

  startedAt     DateTime?
  completedAt   DateTime?

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([userId, status])
  @@map("training_plans")
}

model Exercise {
  id              String          @id @default(cuid())
  trainingPlanId  String
  trainingPlan    TrainingPlan    @relation(fields: [trainingPlanId], references: [id], onDelete: Cascade)

  name            String
  description     String
  instructions    String

  dayNumber       Int
  orderInDay      Int

  sets            Int?
  reps            Int?
  durationMins    Int?
  restSeconds     Int?

  videoUrl        String?
  imageUrls       String[]        @default([])

  frequency       String

  targetIssues    ExerciseIssue[]
  progressLogs    ProgressLog[]

  createdAt       DateTime        @default(now())

  @@index([trainingPlanId, dayNumber])
  @@map("exercises")
}

model ExerciseIssue {
  id          String   @id @default(cuid())
  exerciseId  String
  exercise    Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  issueId     String
  issue       Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@unique([exerciseId, issueId])
  @@map("exercise_issues")
}

model ProgressLog {
  id              String       @id @default(cuid())
  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  trainingPlanId  String
  trainingPlan    TrainingPlan @relation(fields: [trainingPlanId], references: [id], onDelete: Cascade)
  exerciseId      String?
  exercise        Exercise?    @relation(fields: [exerciseId], references: [id])

  date            DateTime     @db.Date
  completed       Boolean      @default(false)
  setsCompleted   Int?
  repsCompleted   Int?
  durationMins    Int?

  difficulty      Int?
  notes           String?

  createdAt       DateTime     @default(now())

  @@unique([trainingPlanId, exerciseId, date])
  @@index([userId, date])
  @@map("progress_logs")
}

// ============================================
// EXERCISE LIBRARY
// ============================================

model ExerciseTemplate {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  description String
  instructions String

  category    String
  targetAreas String[]
  sportSlugs  String[]

  defaultSets Int?
  defaultReps Int?
  defaultDurationMins Int?

  videoUrl    String?
  imageUrls   String[] @default([])

  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("exercise_templates")
}

// ============================================
// AUTH & VERIFICATION
// ============================================

model VerificationToken {
  id        String    @id @default(cuid())
  token     String    @unique
  type      TokenType
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([token])
  @@map("verification_tokens")
}

// ============================================
// GAMIFICATION
// ============================================

model UserStreak {
  id               String    @id @default(cuid())
  userId           String    @unique
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentStreak    Int       @default(0)
  longestStreak    Int       @default(0)
  lastActivityAt   DateTime?
  freezesAvailable Int       @default(1)
  freezeUsedAt     DateTime?

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@map("user_streaks")
}

model UserBadge {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeType BadgeType
  earnedAt  DateTime  @default(now())

  @@unique([userId, badgeType])
  @@index([userId])
  @@map("user_badges")
}

model ActivityLog {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date          DateTime @db.Date
  analysisCount Int      @default(0)
  exerciseCount Int      @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId, date])
  @@map("activity_logs")
}

// ============================================
// RAG - KNOWLEDGE BASE
// ============================================

model Document {
  id           String         @id @default(cuid())
  filename     String
  originalName String
  fileUrl      String
  fileSize     Int
  pageCount    Int?
  sportSlug    String?
  language     String         @default("es")
  status       DocumentStatus @default(UPLOADING)
  errorMessage String?
  uploadedById String
  uploadedBy   User           @relation(fields: [uploadedById], references: [id])
  chunks       DocumentChunk[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@map("documents")
}

model DocumentChunk {
  id         String        @id @default(cuid())
  documentId String
  document   Document      @relation(fields: [documentId], references: [id], onDelete: Cascade)
  content    String
  chunkIndex Int
  pageStart  Int?
  pageEnd    Int?
  sportSlug  String?
  category   ChunkCategory @default(GENERAL)
  technique  String?
  tokenCount Int?
  createdAt  DateTime      @default(now())

  // Note: embedding vector(768) column added via raw SQL migration (Gemini text-embedding-004)

  @@index([documentId])
  @@index([sportSlug])
  @@index([category])
  @@index([technique])
  @@map("document_chunks")
}
